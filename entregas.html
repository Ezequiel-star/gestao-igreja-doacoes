<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Entrega - Igreja Gest√£o</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body {
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('imagen/cruz 2.jpg') no-repeat;
            background-size: cover; background-position: center; padding: 20px; color: #fff;
        }

        .container {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px; backdrop-filter: blur(15px); padding: 40px; 
            width: 100%; max-width: 500px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        h2 { margin-bottom: 25px; color: #87ffad; text-align: center; text-transform: uppercase; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 0.9em; color: #ccc; }

        select, input {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3);
            background: rgba(0, 0, 0, 0.4); color: #fff; outline: none;
        }

        option { background-color: #162938; color: #fff; }

        .btn-confirmar {
            width: 100%; padding: 15px; background: #87ffad; color: #162938; 
            border: none; border-radius: 10px; font-weight: 700; cursor: pointer; 
            text-transform: uppercase; transition: 0.3s;
        }
        .btn-confirmar:hover { background: #fff; transform: scale(1.02); }
        .btn-voltar { display: block; text-align: center; margin-top: 20px; color: #ccc; text-decoration: none; font-size: 0.9em; }
    </style>
</head>
<body>

    <div class="container">
        <h2>üöö Registrar Entrega</h2>
        
        <div class="form-group">
            <label>Fam√≠lia Benefici√°ria</label>
            <select id="selectFamilia">
                <option value="">Carregando fam√≠lias...</option>
            </select>
        </div>

        <div class="form-group">
            <label>Item Dispon√≠vel no Estoque</label>
            <select id="selectItemDoacao">
                <option value="">Carregando estoque...</option>
            </select>
        </div>

        <div class="form-group">
            <label>Quantidade a Entregar</label>
            <input type="number" id="quantidade" value="1" min="1">
        </div>

        <button class="btn-confirmar" onclick="confirmarEntrega()">Confirmar Entrega</button>
        <a href="menuprincipal.html" class="btn-voltar">‚Üê Voltar ao Menu</a>
    </div>

    <script>
        const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');

        // 1. CARREGAR FAM√çLIAS
        async function carregarFamilias() {
            try {
                const res = await fetch('https://gestao-igreja-doacoes.onrender.com/api/beneficiario/listar', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const familias = await res.json();
                const select = document.getElementById('selectFamilia');
                select.innerHTML = '<option value="">Selecione uma fam√≠lia...</option>';
                familias.forEach(f => {
                    select.innerHTML += `<option value="${f.cpf_responsavel}">${f.nome_responsavel}</option>`;
                });
            } catch (err) { console.error("Erro ao carregar fam√≠lias:", err); }
        }

        // 2. CARREGAR ITENS DO ESTOQUE
        async function carregarEstoque() {
            try {
                const res = await fetch('https://gestao-igreja-doacoes.onrender.com/api/doacao/listar', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const itens = await res.json();
                const select = document.getElementById('selectItemDoacao');
                select.innerHTML = '<option value="">Escolha o item no estoque...</option>';
                
                itens.forEach(i => {
                    // S√≥ mostra se tiver saldo
                    if(i.quantidade > 0) {
                        // Guardamos o saldo no atributo data-saldo para validar depois
                        select.innerHTML += `<option value="${i.id_doacao}" data-saldo="${i.quantidade}">${i.tipo_item} (Dispon√≠vel: ${i.quantidade})</option>`;
                    }
                });
            } catch (err) { console.error("Erro ao carregar estoque:", err); }
        }

        // 3. CONFIRMAR ENTREGA
        async function confirmarEntrega() {
            const selectItem = document.getElementById('selectItemDoacao');
            const optionSelecionada = selectItem.options[selectItem.selectedIndex];
            
            const cpf = document.getElementById('selectFamilia').value;
            const idDoacao = selectItem.value;
            const qtd = parseInt(document.getElementById('quantidade').value);
            
            // PEGA O SALDO QUE SALVAMOS NO DATA-ATTRIBUTE
            const saldoDisponivel = parseInt(optionSelecionada.getAttribute('data-saldo'));

            if (!cpf || !idDoacao) return alert("Por favor, selecione a fam√≠lia e o item!");

            // VALIDA√á√ÉO DE ENGENHARIA: Impede entrega maior que o estoque
            if (qtd > saldoDisponivel) {
                alert(`‚ùå Erro: Estoque insuficiente! Voc√™ s√≥ possui ${saldoDisponivel} unidades deste item.`);
                return;
            }

            const payload = {
                cpf_beneficiario: cpf,
                itens_entregues: [
                    {
                        id_doacao: parseInt(idDoacao),
                        quantidade_entregue: qtd
                    }
                ]
            };

            try {
                const res = await fetch('https://gestao-igreja-doacoes.onrender.com/api/entrega/registrar', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("‚úÖ Entrega registrada com sucesso! O estoque foi atualizado.");
                    window.location.href = "menuprincipal.html";
                } else {
                    const erro = await res.json();
                    alert("‚ùå Falha: " + (erro.message || "Erro ao processar entrega no servidor."));
                }
            } catch (err) {
                alert("Erro cr√≠tico de conex√£o com o servidor.");
            }
        }

        window.onload = () => {
            carregarFamilias();
            carregarEstoque();
        };
    </script>
</body>
</html>